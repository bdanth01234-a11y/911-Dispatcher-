<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>911 Emergency Dispatcher - Version 2.0</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@500;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-green: #00ff41;
            --dark-green: #008f11;
            --amber: #ffb000;
            --red: #ff0040;
            --blue: #00d4ff;
            --bg-dark: #0a0a0f;
            --panel-bg: rgba(10, 15, 20, 0.95);
        }

        html, body {
            font-family: 'Share Tech Mono', monospace;
            background: var(--bg-dark);
            color: var(--primary-green);
            height: 100%;
            width: 100%;
            overflow: hidden;
            position: fixed;
        }

        /* Background Effects */
        .bg-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 65, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 65, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: gridMove 20s linear infinite;
            pointer-events: none;
            z-index: 0;
        }

        @keyframes gridMove {
            0% { transform: perspective(500px) rotateX(60deg) translateY(0); }
            100% { transform: perspective(500px) rotateX(60deg) translateY(50px); }
        }

        .crt-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%),
                linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 1000;
            animation: flicker 0.15s infinite;
        }

        .scanline {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 10px;
            background: rgba(0, 255, 65, 0.1);
            opacity: 0.4;
            animation: scanline 8s linear infinite;
            pointer-events: none;
            z-index: 999;
        }

        @keyframes scanline {
            0% { transform: translateY(-100vh); }
            100% { transform: translateY(100vh); }
        }

        @keyframes flicker {
            0% { opacity: 0.97; }
            50% { opacity: 0.99; }
            100% { opacity: 0.98; }
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, rgba(0,20,10,0.95) 0%, rgba(0,10,5,0.9) 100%);
            padding: 10px 20px;
            border-bottom: 2px solid var(--primary-green);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
            position: relative;
            z-index: 100;
            height: 60px;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 24px;
            text-shadow: 0 0 10px var(--primary-green);
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            letter-spacing: 2px;
        }

        .header-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .header-btn {
            background: rgba(0, 20, 10, 0.8);
            border: 1px solid var(--primary-green);
            border-radius: 4px;
            color: var(--primary-green);
            padding: 8px 15px;
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            font-size: 12px;
            transition: all 0.3s;
        }

        .header-btn:hover {
            background: var(--primary-green);
            color: #000;
        }

        /* Volume Control - Collapsible */
        .volume-container {
            position: relative;
        }

        .volume-toggle {
            background: rgba(0, 20, 10, 0.8);
            border: 1px solid var(--primary-green);
            border-radius: 4px;
            color: var(--primary-green);
            padding: 8px 12px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s;
        }

        .volume-toggle:hover {
            background: var(--primary-green);
            color: #000;
        }

        .volume-panel {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: rgba(0, 10, 5, 0.95);
            border: 1px solid var(--primary-green);
            border-radius: 8px;
            padding: 15px;
            display: none;
            z-index: 2000;
            min-width: 150px;
        }

        .volume-panel.show {
            display: block;
        }

        .volume-slider {
            width: 120px;
            accent-color: var(--primary-green);
        }

        .volume-label {
            font-size: 11px;
            color: #888;
            margin-top: 8px;
            text-align: center;
        }

        /* Main Layout - Fixed Grid */
        .main-layout {
            display: grid;
            grid-template-columns: 280px 1fr 320px;
            grid-template-rows: 1fr auto;
            gap: 15px;
            padding: 15px;
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 160px;
            z-index: 10;
        }

        /* Left Column - Info & Audio */
        .left-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 100%;
            overflow: hidden;
        }

        /* Center Column - Chat Only */
        .center-column {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
            min-width: 0;
        }

        /* Right Column - Notepad Only */
        .right-column {
            display: flex;
            flex-direction: column;
            height: 100%;
            overflow: hidden;
        }

        /* Panels */
        .panel {
            background: var(--panel-bg);
            border: 1px solid rgba(0, 255, 65, 0.3);
            border-radius: 8px;
            padding: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }

        .panel-title {
            font-size: 13px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--amber);
            border-bottom: 1px solid rgba(255, 176, 0, 0.3);
            padding-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            flex-shrink: 0;
        }

        /* Caller Info */
        .caller-info {
            font-size: 12px;
            line-height: 1.8;
            overflow-y: auto;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 6px;
            background: rgba(0, 255, 65, 0.05);
            border-radius: 4px;
            border-left: 3px solid var(--primary-green);
        }

        .info-label {
            color: #888;
            font-size: 10px;
            text-transform: uppercase;
        }

        .info-value {
            color: var(--primary-green);
            font-weight: bold;
            font-size: 11px;
        }

        /* Audio Viz */
        .audio-viz {
            display: flex;
            align-items: flex-end;
            justify-content: center;
            height: 60px;
            gap: 3px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 6px;
            border: 1px solid rgba(0, 255, 65, 0.2);
        }

        .bar {
            width: 5px;
            background: linear-gradient(180deg, var(--primary-green), var(--dark-green));
            border-radius: 2px 2px 0 0;
            transition: height 0.1s ease;
        }

        .bar:nth-child(1) { height: 10%; }
        .bar:nth-child(2) { height: 30%; }
        .bar:nth-child(3) { height: 50%; }
        .bar:nth-child(4) { height: 20%; }
        .bar:nth-child(5) { height: 60%; }
        .bar:nth-child(6) { height: 40%; }
        .bar:nth-child(7) { height: 70%; }
        .bar:nth-child(8) { height: 35%; }

        .audio-viz.active .bar {
            animation: sound 0.5s ease infinite alternate;
        }

        @keyframes sound {
            0% { height: 10%; }
            100% { height: 85%; }
        }

        .audio-viz.silent .bar {
            animation: none;
            height: 10% !important;
            opacity: 0.3;
        }

        .audio-status {
            text-align: center;
            margin-top: 8px;
            font-size: 11px;
            color: var(--amber);
        }

        /* Chat Container - ONLY SCROLLABLE AREA */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 12px;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 65, 0.2);
        }

        .chat-container::-webkit-scrollbar {
            width: 10px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 5px;
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--primary-green), var(--dark-green));
            border-radius: 5px;
            border: 2px solid rgba(0, 0, 0, 0.8);
        }

        .chat-message {
            margin-bottom: 12px;
            padding: 10px;
            border-radius: 8px;
            animation: messageIn 0.3s ease;
            word-wrap: break-word;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .caller-msg {
            background: linear-gradient(135deg, rgba(255, 176, 0, 0.15), rgba(255, 176, 0, 0.05));
            border-left: 3px solid var(--amber);
            margin-right: 20%;
        }

        .dispatcher-msg {
            background: linear-gradient(135deg, rgba(0, 255, 65, 0.15), rgba(0, 255, 65, 0.05));
            border-right: 3px solid var(--primary-green);
            margin-left: 20%;
            text-align: right;
        }

        .system-msg {
            background: rgba(100, 100, 100, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
            font-style: italic;
            color: #888;
            margin: 8px 15%;
            font-size: 12px;
        }

        .radio-msg {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.15), rgba(0, 212, 255, 0.05));
            border-left: 3px solid var(--blue);
            margin-right: 30%;
        }

        .msg-time {
            font-size: 10px;
            color: #666;
            margin-bottom: 4px;
            font-family: 'Rajdhani', sans-serif;
        }

        .msg-sender {
            font-weight: bold;
            font-size: 11px;
            margin-bottom: 4px;
            text-transform: uppercase;
        }

        .caller-msg .msg-sender { color: var(--amber); }
        .dispatcher-msg .msg-sender { color: var(--primary-green); }
        .radio-msg .msg-sender { color: var(--blue); }

        /* Response Area - Fixed below chat */
        .response-section {
            margin-top: 12px;
            background: rgba(0, 20, 10, 0.9);
            border: 2px solid var(--amber);
            border-radius: 8px;
            padding: 12px;
            flex-shrink: 0;
        }

        .response-header {
            color: var(--amber);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
        }

        .response-input-row {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .response-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(0, 255, 65, 0.3);
            border-radius: 6px;
            padding: 10px;
            color: var(--primary-green);
            font-family: 'Share Tech Mono', monospace;
            font-size: 13px;
            outline: none;
        }

        .response-input:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.2);
        }

        .send-btn {
            padding: 10px 20px;
            background: linear-gradient(180deg, var(--primary-green), var(--dark-green));
            border: none;
            border-radius: 6px;
            color: #000;
            font-weight: bold;
            cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
            text-transform: uppercase;
        }

        .send-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .suggestion-chip {
            background: rgba(255, 176, 0, 0.1);
            border: 1px solid rgba(255, 176, 0, 0.3);
            border-radius: 15px;
            padding: 4px 10px;
            font-size: 11px;
            color: var(--amber);
            cursor: pointer;
            transition: all 0.2s;
        }

        .suggestion-chip:hover {
            background: rgba(255, 176, 0, 0.2);
        }

        /* Notepad - Fixed, no scroll with chat */
        .notepad-container {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .notepad-header {
            background: linear-gradient(180deg, #8b4513, #654321);
            color: #fff;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            font-family: 'Rajdhani', sans-serif;
            letter-spacing: 2px;
            border: 2px solid #5a3a1a;
            border-bottom: none;
            font-size: 13px;
        }

        .notepad {
            flex: 1;
            background: #f5f5dc;
            color: #2c1810;
            border: 2px solid #8b4513;
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            resize: none;
            outline: none;
            line-height: 24px;
            background-image: linear-gradient(#e8e8d0 1px, transparent 1px);
            background-size: 100% 24px;
            overflow-y: auto;
        }

        .notepad::-webkit-scrollbar {
            width: 10px;
        }

        .notepad::-webkit-scrollbar-thumb {
            background: #8b4513;
            border-radius: 5px;
        }

        /* Bottom Control Bar - Fixed */
        .control-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 160px;
            background: linear-gradient(180deg, rgba(10,15,20,0.98) 0%, rgba(5,10,5,0.99) 100%);
            border-top: 2px solid var(--primary-green);
            padding: 15px;
            display: grid;
            grid-template-columns: 2fr 1fr 280px;
            gap: 15px;
            z-index: 100;
        }

        .dispatch-section {
            display: flex;
            flex-direction: column;
        }

        .section-label {
            color: var(--amber);
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
        }

        .dispatch-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            flex: 1;
        }

        .dispatch-btn {
            background: linear-gradient(180deg, rgba(0,40,20,0.9), rgba(0,20,10,0.95));
            border: 2px solid var(--primary-green);
            border-radius: 6px;
            color: var(--primary-green);
            cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
            font-size: 12px;
            font-weight: 700;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .dispatch-btn:hover {
            background: rgba(0, 255, 65, 0.2);
            transform: translateY(-2px);
        }

        .dispatch-btn.active {
            background: rgba(255, 0, 64, 0.3);
            border-color: var(--red);
            color: var(--red);
            animation: pulse 2s infinite;
        }

        .dispatch-icon {
            font-size: 20px;
        }

        /* Radio Section */
        .radio-section {
            display: flex;
            flex-direction: column;
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid var(--blue);
            border-radius: 8px;
            padding: 10px;
        }

        .radio-channels {
            display: flex;
            gap: 4px;
            margin-bottom: 8px;
        }

        .radio-channel-btn {
            flex: 1;
            padding: 4px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid #333;
            border-radius: 4px;
            color: #666;
            cursor: pointer;
            font-size: 9px;
            text-transform: uppercase;
        }

        .radio-channel-btn.active {
            border-color: var(--blue);
            color: var(--blue);
            background: rgba(0, 212, 255, 0.1);
        }

        .radio-messages {
            flex: 1;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--blue);
            border-radius: 4px;
            padding: 8px;
            overflow-y: auto;
            font-size: 11px;
            color: var(--blue);
            margin-bottom: 8px;
            max-height: 60px;
        }

        .radio-input-row {
            display: flex;
            gap: 6px;
        }

        .radio-input {
            flex: 1;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--blue);
            border-radius: 4px;
            padding: 6px;
            color: var(--blue);
            font-family: 'Share Tech Mono', monospace;
            font-size: 11px;
        }

        .radio-send-btn {
            padding: 6px 12px;
            background: var(--blue);
            border: none;
            border-radius: 4px;
            color: #000;
            font-weight: bold;
            font-size: 11px;
            cursor: pointer;
        }

        /* Action Buttons */
        .action-section {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .action-btn {
            padding: 12px;
            background: linear-gradient(180deg, rgba(0,40,20,0.9), rgba(0,20,10,0.95));
            border: 2px solid var(--primary-green);
            border-radius: 6px;
            color: var(--primary-green);
            cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
            font-size: 14px;
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.3s;
        }

        .action-btn:hover:not(:disabled) {
            background: rgba(0, 255, 65, 0.2);
        }

        .answer-btn {
            background: rgba(255, 0, 64, 0.3);
            border-color: var(--red);
            color: #fff;
            animation: pulse 1.5s infinite;
        }

        .action-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 5000;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(180deg, rgba(10,20,15,0.98), rgba(5,10,5,0.99));
            border: 3px solid var(--primary-green);
            border-radius: 16px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 0 60px rgba(0, 255, 65, 0.3);
        }

        .modal-title {
            font-size: 32px;
            color: var(--primary-green);
            text-align: center;
            margin-bottom: 20px;
            font-family: 'Rajdhani', sans-serif;
            text-transform: uppercase;
            letter-spacing: 3px;
        }

        .modal-text {
            color: #ccc;
            line-height: 1.8;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }

        .modal-btn {
            padding: 15px 30px;
            background: transparent;
            border: 2px solid var(--primary-green);
            border-radius: 8px;
            color: var(--primary-green);
            cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s;
        }

        .modal-btn:hover {
            background: var(--primary-green);
            color: #000;
        }

        .modal-btn.primary {
            background: var(--primary-green);
            color: #000;
        }

        .modal-btn.primary:hover {
            background: #fff;
            box-shadow: 0 0 20px var(--primary-green);
        }

        /* Update Log */
        .update-log {
            background: rgba(0, 0, 0, 0.5);
            border-left: 4px solid var(--amber);
            padding: 20px;
            margin: 20px 0;
            border-radius: 0 8px 8px 0;
        }

        .update-version {
            color: var(--amber);
            font-size: 18px;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .update-list {
            list-style: none;
            color: #aaa;
        }

        .update-list li {
            padding: 5px 0;
            padding-left: 20px;
            position: relative;
        }

        .update-list li::before {
            content: '‚ñ∏';
            position: absolute;
            left: 0;
            color: var(--primary-green);
        }

        /* Pause Menu */
        .pause-menu {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .pause-btn {
            padding: 20px;
            background: rgba(0, 20, 10, 0.8);
            border: 2px solid var(--primary-green);
            border-radius: 8px;
            color: var(--primary-green);
            cursor: pointer;
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            text-transform: uppercase;
            transition: all 0.3s;
        }

        .pause-btn:hover {
            background: var(--primary-green);
            color: #000;
            transform: translateY(-2px);
        }

        .pause-btn.danger {
            border-color: var(--red);
            color: var(--red);
        }

        .pause-btn.danger:hover {
            background: var(--red);
            color: #fff;
        }

        /* Stats Display */
        .stats-display {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid rgba(0, 255, 65, 0.2);
        }

        .stat-value-large {
            font-size: 28px;
            color: var(--primary-green);
            font-weight: bold;
            font-family: 'Rajdhani', sans-serif;
        }

        .stat-label-small {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            margin-top: 5px;
        }

        /* Opening Response Choice */
        .opening-choice {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin: 20px 0;
        }

        .choice-btn {
            padding: 15px 20px;
            background: rgba(0, 20, 10, 0.8);
            border: 2px solid var(--amber);
            border-radius: 8px;
            color: var(--amber);
            cursor: pointer;
            font-family: 'Share Tech Mono', monospace;
            font-size: 14px;
            text-align: left;
            transition: all 0.3s;
        }

        .choice-btn:hover {
            background: rgba(255, 176, 0, 0.1);
            padding-left: 30px;
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        /* Animations */
        @keyframes pulse {
            0%, 100% { box-shadow: 0 0 20px rgba(0, 255, 65, 0.4); }
            50% { box-shadow: 0 0 30px rgba(0, 255, 65, 0.6); }
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .main-layout {
                grid-template-columns: 250px 1fr 280px;
            }
        }
    </style>
</head>
<body>
    <div class="bg-grid"></div>
    <div class="crt-overlay"></div>
    <div class="scanline"></div>

    <!-- Header -->
    <div class="header">
        <h1>
            <span>üö®</span>
            DISPATCH CENTER <span style="font-size: 14px; color: #666;">v2.0</span>
        </h1>
        <div class="header-controls">
            <button class="header-btn" onclick="togglePause()">‚è∏ PAUSE</button>
            <div class="volume-container">
                <button class="volume-toggle" onclick="toggleVolume()">üîä</button>
                <div class="volume-panel" id="volumePanel">
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70" oninput="updateVolume(this.value)">
                    <div class="volume-label" id="volumeLabel">70%</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Layout -->
    <div class="main-layout">
        <!-- Left Column -->
        <div class="left-column">
            <div class="panel" style="flex: 1;">
                <div class="panel-title">
                    <span>üìû</span> Caller Information
                </div>
                <div class="caller-info" id="callerInfo">
                    <div class="info-row">
                        <span class="info-label">CALLER ID</span>
                        <span class="info-value" id="callerId">---</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">LOCATION</span>
                        <span class="info-value" id="callerLocation">---</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">PHONE</span>
                        <span class="info-value" id="callerPhone">---</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">EMERGENCY TYPE</span>
                        <span class="info-value" id="emergencyType" style="color: var(--amber);">---</span>
                    </div>
                </div>
            </div>
            
            <div class="panel" style="height: 140px;">
                <div class="panel-title">
                    <span>üîä</span> Audio Monitor
                </div>
                <div class="audio-viz silent" id="audioViz">
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                    <div class="bar"></div>
                </div>
                <div class="audio-status" id="audioStatus">NO SIGNAL</div>
            </div>
        </div>

        <!-- Center Column - Chat Only -->
        <div class="center-column">
            <div class="panel" style="height: 100%;">
                <div class="panel-title">
                    <span>üìã</span> Call Transcript
                    <span style="margin-left: auto; font-size: 10px; color: #666;">SCROLL WITH MOUSE WHEEL</span>
                </div>
                
                <!-- Only this scrolls -->
                <div class="chat-container" id="chatContainer">
                    <div class="system-msg" style="padding: 30px; font-size: 16px; color: var(--red); animation: pulse 2s infinite;">
                        üìû INCOMING EMERGENCY CALL<br>
                        <span style="font-size: 12px; color: #666;">Standby for dispatch...</span>
                    </div>
                </div>

                <!-- Response Area - Fixed -->
                <div class="response-section" id="responseSection" style="display: none;">
                    <div class="response-header">
                        <span>üé§ TYPE YOUR RESPONSE</span>
                        <span style="color: #666;">ENTER TO SEND</span>
                    </div>
                    <div class="response-input-row">
                        <input type="text" class="response-input" id="responseInput" placeholder="Type your response..." maxlength="200" disabled>
                        <button class="send-btn" id="sendBtn" onclick="sendResponse()" disabled>SEND</button>
                    </div>
                    <div class="suggestions" id="suggestions"></div>
                </div>
            </div>
        </div>

        <!-- Right Column - Notepad Only -->
        <div class="right-column">
            <div class="notepad-container">
                <div class="notepad-header">üìù INCIDENT NOTEPAD</div>
                <textarea class="notepad" id="notepad" placeholder="TYPE NOTES HERE...&#10;&#10;Capture:&#10;- Exact location&#10;- Nature of emergency&#10;- Number of people&#10;- Injuries/conditions&#10;- Suspect descriptions&#10;- Weapons involved&#10;- Vehicle information&#10;- Hazards present"></textarea>
            </div>
        </div>
    </div>

    <!-- Bottom Control Bar -->
    <div class="control-bar">
        <div class="dispatch-section">
            <div class="section-label">üöî Dispatch Units</div>
            <div class="dispatch-grid">
                <button class="dispatch-btn" id="btnPolice" onclick="toggleDispatch('police')">
                    <span class="dispatch-icon">üöì</span>
                    <span>POLICE</span>
                </button>
                <button class="dispatch-btn" id="btnFire" onclick="toggleDispatch('fire')">
                    <span class="dispatch-icon">üöí</span>
                    <span>FIRE</span>
                </button>
                <button class="dispatch-btn" id="btnEms" onclick="toggleDispatch('ems')">
                    <span class="dispatch-icon">üöë</span>
                    <span>EMS</span>
                </button>
                <button class="dispatch-btn" id="btnSwat" onclick="toggleDispatch('swat')">
                    <span class="dispatch-icon">‚öîÔ∏è</span>
                    <span>SWAT</span>
                </button>
            </div>
        </div>

        <div class="radio-section">
            <div class="section-label" style="color: var(--blue);">üìª Radio Communication</div>
            <div class="radio-channels">
                <button class="radio-channel-btn active" id="chPolice" onclick="setRadioChannel('police')">POLICE</button>
                <button class="radio-channel-btn" id="chFire" onclick="setRadioChannel('fire')">FIRE</button>
                <button class="radio-channel-btn" id="chEms" onclick="setRadioChannel('ems')">EMS</button>
                <button class="radio-channel-btn" id="chSwat" onclick="setRadioChannel('swat')">SWAT</button>
            </div>
            <div class="radio-messages" id="radioMessages">
                <div style="color: #555; font-style: italic;">Select channel...</div>
            </div>
            <div class="radio-input-row">
                <input type="text" class="radio-input" id="radioInput" placeholder="Message to units..." maxlength="100">
                <button class="radio-send-btn" onclick="sendRadioMessage()">SEND</button>
            </div>
        </div>

        <div class="action-section">
            <button class="action-btn answer-btn" id="answerBtn" onclick="answerCall()">ANSWER CALL</button>
            <button class="action-btn" id="endBtn" onclick="endCall()" disabled>END CALL</button>
            <button class="action-btn" onclick="clearNotepad()">CLEAR NOTES</button>
        </div>
    </div>

    <!-- Update Log Modal -->
    <div class="modal-overlay" id="updateModal">
        <div class="modal-content">
            <h2 class="modal-title">üÜï UPDATE INSTALLED</h2>
            <div class="update-log">
                <div class="update-version">Version 2.0 - Major Update</div>
                <ul class="update-list">
                    <li>Complete UI redesign with fixed layout</li>
                    <li>Chat now scrolls independently</li>
                    <li>Context-aware AI responses</li>
                    <li>Personal best time tracking</li>
                    <li>End shift statistics</li>
                    <li>Radio feedback from units</li>
                    <li>Collapsible volume control</li>
                    <li>Pause menu functionality</li>
                    <li>Custom opening greetings</li>
                    <li>Removed duplicate auto-messages</li>
                </ul>
            </div>
            <div class="modal-text" style="text-align: center; color: #888;">
                Your progress and statistics are automatically saved.
            </div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="dismissUpdate()">START DISPATCHING</button>
            </div>
        </div>
    </div>

    <!-- Opening Choice Modal -->
    <div class="modal-overlay" id="openingModal">
        <div class="modal-content">
            <h2 class="modal-title">üìû INCOMING CALL</h2>
            <div class="modal-text">
                A 911 call is coming in. How would you like to answer?
            </div>
            <div class="opening-choice">
                <button class="choice-btn" onclick="chooseOpening('standard')">
                    <strong>Standard Protocol:</strong> "911, what's your emergency?"
                </button>
                <button class="choice-btn" onclick="chooseOpening('location')">
                    <strong>Location First:</strong> "911, what is the address of your emergency?"
                </button>
                <button class="choice-btn" onclick="chooseOpening('custom')">
                    <strong>Custom Response:</strong> Type your own greeting...
                </button>
            </div>
            <div id="customOpening" style="display: none; margin-top: 15px;">
                <input type="text" id="customOpeningInput" class="response-input" placeholder="Type your custom greeting..." style="width: 100%;">
                <button class="modal-btn primary" onclick="confirmCustomOpening()" style="margin-top: 10px; width: 100%;">ANSWER WITH CUSTOM GREETING</button>
            </div>
        </div>
    </div>

    <!-- Pause Menu Modal -->
    <div class="modal-overlay" id="pauseModal">
        <div class="modal-content">
            <h2 class="modal-title">‚è∏ PAUSED</h2>
            <div class="modal-text" style="text-align: center;">
                Current Call Timer: <span id="pauseTimer" style="color: var(--amber); font-size: 24px;">00:00</span>
            </div>
            <div class="pause-menu">
                <button class="pause-btn" onclick="resumeGame()">‚ñ∂ RESUME</button>
                <button class="pause-btn" onclick="showStats()">üìä STATISTICS</button>
                <button class="pause-btn" onclick="showSettings()">‚öô SETTINGS</button>
                <button class="pause-btn danger" onclick="confirmEndShift()">üö™ END SHIFT</button>
            </div>
        </div>
    </div>

    <!-- End Call Stats Modal -->
    <div class="modal-overlay" id="endCallModal">
        <div class="modal-content">
            <h2 class="modal-title" style="color: var(--red);">CALL ENDED</h2>
            <div class="stats-display">
                <div class="stat-item">
                    <div class="stat-value-large" id="endGrade">A+</div>
                    <div class="stat-label-small">Grade</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value-large" id="endScore">95%</div>
                    <div class="stat-label-small">Score</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value-large" id="endTime">03:45</div>
                    <div class="stat-label-small">Call Time</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value-large" id="endBest" style="color: var(--amber);">02:30</div>
                    <div class="stat-label-small">Personal Best</div>
                </div>
            </div>
            <div class="modal-text" id="endFeedback" style="text-align: center;">
                Excellent work! You handled this emergency professionally.
            </div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="nextCall()">NEXT CALL</button>
            </div>
        </div>
    </div>

    <!-- End Shift Modal -->
    <div class="modal-overlay" id="endShiftModal">
        <div class="modal-content" style="max-width: 700px;">
            <h2 class="modal-title" style="color: var(--amber);">üåÖ SHIFT COMPLETE</h2>
            <div class="stats-display" style="grid-template-columns: repeat(3, 1fr);">
                <div class="stat-item">
                    <div class="stat-value-large" id="shiftTotalCalls">0</div>
                    <div class="stat-label-small">Total Calls</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value-large" id="shiftAvgTime">00:00</div>
                    <div class="stat-label-small">Avg. Response Time</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value-large" id="shiftBestTime" style="color: var(--amber);">--:--</div>
                    <div class="stat-label-small">Best Call Time</div>
                </div>
            </div>
            <div class="update-log" style="margin: 20px 0;">
                <div class="update-version">Performance Analysis</div>
                <div id="shiftAnalysis" style="color: #aaa; line-height: 1.8;">
                    Loading analysis...
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn" onclick="closeShiftModal()">RETURN TO MENU</button>
                <button class="modal-btn primary" onclick="startNewShift()">START NEW SHIFT</button>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div class="modal-overlay" id="statsModal">
        <div class="modal-content">
            <h2 class="modal-title">üìä CAREER STATISTICS</h2>
            <div class="stats-display">
                <div class="stat-item">
                    <div class="stat-value-large" id="careerTotalCalls">0</div>
                    <div class="stat-label-small">Total Calls</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value-large" id="careerBestTime">--:--</div>
                    <div class="stat-label-small">Best Time</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value-large" id="careerAvgScore">0%</div>
                    <div class="stat-label-small">Avg. Score</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value-large" id="careerGrade">B</div>
                    <div class="stat-label-small">Overall Grade</div>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="modal-btn primary" onclick="closeStats()">BACK</button>
            </div>
        </div>
    </div>

    <script>
        // Game State
        const GAME_VERSION = '2.0';
        let currentCall = null;
        let callInProgress = false;
        let callStartTime = null;
        let callTimerInterval = null;
        let transcriptIndex = 0;
        let dispatchedUnits = new Set();
        let callScore = 0;
        let radioChannel = 'police';
        let audioContext = null;
        let volume = 0.7;
        let isPaused = false;
        let pauseStartTime = null;
        let currentContext = '';
        let awaitingResponse = false;
        let conversationHistory = [];

        // Statistics
        let stats = {
            totalCalls: 0,
            totalScore: 0,
            bestTime: null,
            callTimes: [],
            shiftCalls: 0,
            shiftStartTime: Date.now()
        };

        // Load saved data
        function loadGameData() {
            const saved = localStorage.getItem('911DispatcherData');
            if (saved) {
                const data = JSON.parse(saved);
                stats.totalCalls = data.totalCalls || 0;
                stats.totalScore = data.totalScore || 0;
                stats.bestTime = data.bestTime || null;
                stats.callTimes = data.callTimes || [];
                
                // Check if update shown
                const lastVersion = localStorage.getItem('911DispatcherVersion');
                if (lastVersion !== GAME_VERSION) {
                    showUpdateLog();
                    localStorage.setItem('911DispatcherVersion', GAME_VERSION);
                }
            } else {
                showUpdateLog();
                localStorage.setItem('911DispatcherVersion', GAME_VERSION);
            }
        }

        function saveGameData() {
            localStorage.setItem('911DispatcherData', JSON.stringify({
                totalCalls: stats.totalCalls,
                totalScore: stats.totalScore,
                bestTime: stats.bestTime,
                callTimes: stats.callTimes
            }));
        }

        // Audio
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }

        function playTone(freq, duration, type = 'sine') {
            if (!audioContext || volume === 0) return;
            const osc = audioContext.createOscillator();
            const gain = audioContext.createGain();
            osc.connect(gain);
            gain.connect(audioContext.destination);
            osc.frequency.value = freq;
            osc.type = type;
            gain.gain.setValueAtTime(volume * 0.3, audioContext.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            osc.start();
            osc.stop(audioContext.currentTime + duration);
        }

        function playRadioChirp() {
            playTone(800, 0.1);
            setTimeout(() => playTone(1200, 0.1), 100);
        }

        function playDispatchTone() {
            playTone(600, 0.2, 'square');
            setTimeout(() => playTone(800, 0.2, 'square'), 200);
            setTimeout(() => playTone(1000, 0.4, 'square'), 400);
        }

        // Volume Control
        function toggleVolume() {
            document.getElementById('volumePanel').classList.toggle('show');
        }

        function updateVolume(val) {
            volume = val / 100;
            document.getElementById('volumeLabel').textContent = val + '%';
            if (volume === 0) {
                document.querySelector('.volume-toggle').textContent = 'üîá';
            } else {
                document.querySelector('.volume-toggle').textContent = 'üîä';
            }
        }

        // Update Log
        function showUpdateLog() {
            document.getElementById('updateModal').classList.add('show');
        }

        function dismissUpdate() {
            document.getElementById('updateModal').classList.remove('show');
        }

        // Opening Choice
        function answerCall() {
            document.getElementById('openingModal').classList.add('show');
        }

        function chooseOpening(type) {
            if (type === 'custom') {
                document.getElementById('customOpening').style.display = 'block';
                document.getElementById('customOpeningInput').focus();
            } else {
                document.getElementById('openingModal').classList.remove('show');
                startCall(type === 'standard' ? "911, what's your emergency?" : "911, what is the address of your emergency?");
            }
        }

        function confirmCustomOpening() {
            const custom = document.getElementById('customOpeningInput').value.trim();
            if (custom) {
                document.getElementById('openingModal').classList.remove('show');
                startCall(custom);
            }
        }

        // Start Call
        function startCall(openingMessage) {
            initAudio();
            callInProgress = true;
            callStartTime = Date.now();
            transcriptIndex = 0;
            dispatchedUnits.clear();
            callScore = 0;
            conversationHistory = [];
            
            document.getElementById('answerBtn').disabled = true;
            document.getElementById('answerBtn').classList.remove('answer-btn');
            document.getElementById('endBtn').disabled = false;
            document.getElementById('lineStatus').textContent = 'LINE: ACTIVE';
            document.getElementById('lineStatus').classList.remove('emergency-mode');
            document.getElementById('audioViz').classList.remove('silent');
            document.getElementById('audioViz').classList.add('active');
            document.getElementById('audioStatus').textContent = 'CALL CONNECTED';
            document.getElementById('chatContainer').innerHTML = '';
            document.getElementById('responseSection').style.display = 'block';
            
            currentCall = generateScenario();
            
            document.getElementById('callerId').textContent = currentCall.callerName;
            document.getElementById('callerLocation').textContent = currentCall.location;
            document.getElementById('callerPhone').textContent = currentCall.phone;
            document.getElementById('emergencyType').textContent = currentCall.type;
            
            // Add opening message
            addMessage('dispatcher', openingMessage);
            conversationHistory.push({ speaker: 'dispatcher', text: openingMessage });
            
            callTimerInterval = setInterval(updateCallTimer, 1000);
            
            // Start caller response after delay
            setTimeout(() => {
                processCallerLine();
            }, 1500);
        }

        function updateCallTimer() {
            if (isPaused || !callInProgress) return;
            const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
            const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
            const secs = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('callTimer').textContent = `${mins}:${secs}`;
        }

        // AI Response Generation
        function generateAIResponse(playerMessage) {
            const msg = playerMessage.toLowerCase();
            const context = currentCall;
            
            // Check for questions and respond appropriately
            if (msg.includes('name') && (msg.includes('suspect') || msg.includes('who') || msg.includes('person'))) {
                if (context.description) {
                    const names = ['Michael', 'James', 'Robert', 'David', 'John', 'Chris', 'Mike', 'Dave'];
                    const randomName = names[Math.floor(Math.random() * names.length)];
                    return `I think his name is ${randomName}! ${context.description.split(',')[1] || 'He looks dangerous!'}`;
                }
            }
            
            if (msg.includes('weapon') || msg.includes('have a gun') || msg.includes('armed')) {
                if (context.weapon) {
                    return `Yes! He has a ${context.weapon}! Please hurry!`;
                } else {
                    return `I don't see a weapon, but I'm scared!`;
                }
            }
            
            if (msg.includes('location') || msg.includes('where') || msg.includes('address')) {
                return `I'm at ${context.location}! Please send someone now!`;
            }
            
            if (msg.includes('safe') || msg.includes('are you okay')) {
                return `I'm hiding in the ${['bathroom', 'closet', 'bedroom', 'kitchen'][Math.floor(Math.random() * 4)]}. I'm scared but I think I'm safe for now.`;
            }
            
            if (msg.includes('police') || msg.includes('help') || msg.includes('coming')) {
                return `Okay, please hurry! I don't know how long I can stay hidden!`;
            }
            
            if (msg.includes('calm') || msg.includes('breathe')) {
                return `Okay... okay... I'm trying to stay calm. Please just get here fast!`;
            }
            
            // Default responses based on category
            const defaults = {
                MEDICAL: [
                    `Please just send an ambulance! They're getting worse!`,
                    `Hurry! I don't think they're breathing right!`,
                    `The address is ${context.location}! Please!`
                ],
                FIRE: [
                    `The fire is spreading! I can see flames everywhere!`,
                    `Hurry! I think someone is still inside!`,
                    `Please send fire trucks to ${context.location}!`
                ],
                POLICE: [
                    `He's still trying to get in! I can hear him!`,
                    `Please send police now! I'm so scared!`,
                    `I can see him through the window! Hurry!`
                ],
                SWAT: [
                    `There are multiple shooters! I hear gunshots everywhere!`,
                    `People are screaming! Please send SWAT immediately!`,
                    `I'm hiding under a table! I can hear them walking around!`
                ]
            };
            
            const categoryDefaults = defaults[context.category] || defaults.POLICE;
            return categoryDefaults[Math.floor(Math.random() * categoryDefaults.length)];
        }

        function processCallerLine() {
            if (!callInProgress || isPaused) return;
            
            // Check if we need to respond to player
            if (awaitingResponse) return;
            
            // Generate contextual response based on conversation
            const lastPlayerMsg = conversationHistory.filter(h => h.speaker === 'dispatcher').pop();
            let responseText;
            
            if (lastPlayerMsg && transcriptIndex > 0) {
                // AI generates response to what player said
                responseText = generateAIResponse(lastPlayerMsg.text);
            } else {
                // Initial caller opening
                responseText = getOpeningLine(currentCall);
            }
            
            // Visual audio effect
            document.getElementById('audioViz').classList.remove('silent');
            document.getElementById('audioViz').classList.add('active');
            playTone(200 + Math.random() * 400, 0.1);
            
            setTimeout(() => {
                document.getElementById('audioViz').classList.remove('active');
                document.getElementById('audioViz').classList.add('silent');
            }, 1500);
            
            addMessage('caller', responseText);
            conversationHistory.push({ speaker: 'caller', text: responseText });
            
            // Enable response input
            enableResponseInput(responseText);
        }

        function enableResponseInput(callerText) {
            awaitingResponse = true;
            const input = document.getElementById('responseInput');
            const sendBtn = document.getElementById('sendBtn');
            
            input.disabled = false;
            sendBtn.disabled = false;
            input.value = '';
            input.focus();
            
            // Generate suggestions based on context
            const suggestions = generateSuggestions(callerText, currentCall);
            const suggDiv = document.getElementById('suggestions');
            suggDiv.innerHTML = '';
            suggestions.forEach(s => {
                const chip = document.createElement('div');
                chip.className = 'suggestion-chip';
                chip.textContent = s;
                chip.onclick = () => {
                    input.value = s;
                    input.focus();
                };
                suggDiv.appendChild(chip);
            });
        }

        function generateSuggestions(callerText, scenario) {
            const suggestions = [];
            const text = callerText.toLowerCase();
            
            if (text.includes('scared') || text.includes('help')) {
                suggestions.push("Stay calm, help is on the way.");
                suggestions.push("Are you in a safe location right now?");
            }
            
            if (scenario.category === 'MEDICAL' || text.includes('hurt') || text.includes('bleeding')) {
                suggestions.push("Is the person conscious?");
                suggestions.push("Don't move them unless they're in danger.");
            }
            
            if (scenario.category === 'FIRE' || text.includes('fire')) {
                suggestions.push("Get everyone out of the building.");
                suggestions.push("Is anyone trapped inside?");
            }
            
            if (scenario.weapon || text.includes('gun') || text.includes('knife')) {
                suggestions.push("Do not approach the suspect.");
                suggestions.push("Stay hidden and quiet.");
            }
            
            if (scenario.description && !text.includes(scenario.description)) {
                suggestions.push(`What does the suspect look like?`);
            }
            
            suggestions.push("What's your exact location?");
            suggestions.push("Help is being dispatched now.");
            
            return suggestions.slice(0, 4);
        }

        function sendResponse() {
            const input = document.getElementById('responseInput');
            const text = input.value.trim();
            if (!text || !callInProgress) return;
            
            addMessage('dispatcher', text);
            conversationHistory.push({ speaker: 'dispatcher', text: text });
            
            // Score response
            callScore += 10;
            
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;
            document.getElementById('suggestions').innerHTML = '';
            awaitingResponse = false;
            
            // Continue conversation
            transcriptIndex++;
            setTimeout(() => processCallerLine(), 2000);
        }

        document.getElementById('responseInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendResponse();
        });

        function addMessage(sender, text) {
            const container = document.getElementById('chatContainer');
            const div = document.createElement('div');
            const time = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
            
            div.className = `chat-message ${sender}-msg`;
            
            let senderName, senderIcon;
            if (sender === 'caller') {
                senderName = currentCall ? currentCall.callerName : 'CALLER';
                senderIcon = 'üë§';
            } else if (sender === 'dispatcher') {
                senderName = 'YOU';
                senderIcon = 'üéß';
            } else if (sender === 'radio') {
                senderName = `RADIO (${radioChannel.toUpperCase()})`;
                senderIcon = 'üìª';
            } else {
                senderName = 'SYSTEM';
                senderIcon = '‚ö°';
            }
            
            div.innerHTML = `
                <div class="msg-time">${time}</div>
                <div class="msg-sender">${senderIcon} ${senderName}</div>
                <div>${text}</div>
            `;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // Dispatch & Radio
        function toggleDispatch(unit) {
            const btn = document.getElementById(`btn${unit.charAt(0).toUpperCase() + unit.slice(1)}`);
            
            if (dispatchedUnits.has(unit)) {
                dispatchedUnits.delete(unit);
                btn.classList.remove('active');
                addMessage('system', `${unit.toUpperCase()} unit cancelled.`);
            } else {
                dispatchedUnits.add(unit);
                btn.classList.add('active');
                playDispatchTone();
                addMessage('system', `${unit.toUpperCase()} dispatched to ${currentCall.location}.`);
                
                // Radio confirmation
                setTimeout(() => {
                    const confirmations = [
                        `${unit.toUpperCase()}: 10-4, en route.`,
                        `${unit.toUpperCase()}: Copy that, responding.`,
                        `${unit.toUpperCase()}: Roger, ETA 5 minutes.`
                    ];
                    const msg = confirmations[Math.floor(Math.random() * confirmations.length)];
                    addRadioMessage(unit, msg);
                }, 1000);
                
                if (currentCall.requiredUnits.includes(unit)) callScore += 15;
            }
        }

        function setRadioChannel(channel) {
            radioChannel = channel;
            document.querySelectorAll('.radio-channel-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`ch${channel.charAt(0).toUpperCase() + channel.slice(1)}`).classList.add('active');
            playRadioChirp();
        }

        function sendRadioMessage() {
            const input = document.getElementById('radioInput');
            const msg = input.value.trim();
            if (!msg || !callInProgress) return;
            
            playRadioChirp();
            addRadioMessage(radioChannel, `Dispatch: ${msg}`);
            addMessage('radio', `TO ${radioChannel.toUpperCase()}: ${msg}`);
            callScore += 5;
            input.value = '';
            
            // Unit feedback
            setTimeout(() => {
                const feedback = generateRadioFeedback(msg);
                addRadioMessage(radioChannel, `${radioChannel.toUpperCase()}: ${feedback}`);
            }, 1500);
        }

        function generateRadioFeedback(message) {
            const msg = message.toLowerCase();
            
            // Check if message makes sense
            if (msg.length < 5 || (!msg.includes('suspect') && !msg.includes('victim') && !msg.includes('location') && !msg.includes('weapon') && !msg.includes('injured'))) {
                const confused = [
                    "10-9? Say again, dispatch.",
                    "Didn't copy that, please repeat.",
                    "You're breaking up, say again?",
                    "Please repeat last transmission."
                ];
                return confused[Math.floor(Math.random() * confused.length)];
            }
            
            const good = [
                "10-4, copy that.",
                "Roger, understood.",
                "Copy, proceeding accordingly.",
                "10-4, we'll watch for that.",
                "Affirmative, dispatch."
            ];
            
            return good[Math.floor(Math.random() * good.length)];
        }

        function addRadioMessage(channel, text) {
            const display = document.getElementById('radioMessages');
            const div = document.createElement('div');
            div.style.marginBottom = '6px';
            div.style.fontSize = '10px';
            div.innerHTML = `<span style="color: var(--blue); font-weight: bold;">[${channel.toUpperCase()}]</span> ${text}`;
            display.appendChild(div);
            display.scrollTop = display.scrollHeight;
        }

        document.getElementById('radioInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendRadioMessage();
        });

        // Pause Menu
        function togglePause() {
            if (!callInProgress) return;
            
            isPaused = !isPaused;
            if (isPaused) {
                pauseStartTime = Date.now();
                document.getElementById('pauseModal').classList.add('show');
                document.getElementById('pauseTimer').textContent = document.getElementById('callTimer').textContent;
            } else {
                // Adjust call start time to account for pause
                const pauseDuration = Date.now() - pauseStartTime;
                callStartTime += pauseDuration;
                document.getElementById('pauseModal').classList.remove('show');
            }
        }

        function resumeGame() {
            togglePause();
        }

        function showStats() {
            document.getElementById('careerTotalCalls').textContent = stats.totalCalls;
            document.getElementById('careerBestTime').textContent = stats.bestTime || '--:--';
            const avgScore = stats.totalCalls > 0 ? Math.round(stats.totalScore / stats.totalCalls) : 0;
            document.getElementById('careerAvgScore').textContent = avgScore + '%';
            
            let grade = 'F';
            if (avgScore >= 90) grade = 'A';
            else if (avgScore >= 80) grade = 'B';
            else if (avgScore >= 70) grade = 'C';
            else if (avgScore >= 60) grade = 'D';
            document.getElementById('careerGrade').textContent = grade;
            
            document.getElementById('statsModal').classList.add('show');
        }

        function closeStats() {
            document.getElementById('statsModal').classList.remove('show');
        }

        function showSettings() {
            alert('Settings: Use volume button in top right to adjust audio.');
        }

        function confirmEndShift() {
            if (confirm('Are you sure you want to end your shift? Current call will be transferred.')) {
                endShift();
            }
        }

        // End Call
        function endCall() {
            if (!callInProgress) return;
            
            const callDuration = Math.floor((Date.now() - callStartTime) / 1000);
            const minutes = Math.floor(callDuration / 60).toString().padStart(2, '0');
            const seconds = (callDuration % 60).toString().padStart(2, '0');
            const timeStr = `${minutes}:${seconds}`;
            
            // Update stats
            stats.totalCalls++;
            stats.shiftCalls++;
            stats.callTimes.push(callDuration);
            
            // Check personal best
            let isNewBest = false;
            if (!stats.bestTime || callDuration < stats.bestTime) {
                stats.bestTime = callDuration;
                isNewBest = true;
            }
            
            // Calculate score
            const maxScore = 150;
            const percentage = Math.min(100, Math.round((callScore / maxScore) * 100));
            stats.totalScore += percentage;
            
            // Grade
            let grade = 'F';
            if (percentage >= 90) grade = 'A+';
            else if (percentage >= 85) grade = 'A';
            else if (percentage >= 80) grade = 'A-';
            else if (percentage >= 75) grade = 'B+';
            else if (percentage >= 70) grade = 'B';
            else if (percentage >= 65) grade = 'B-';
            else if (percentage >= 60) grade = 'C';
            
            // Display results
            document.getElementById('endGrade').textContent = grade;
            document.getElementById('endScore').textContent = percentage + '%';
            document.getElementById('endTime').textContent = timeStr;
            
            const bestMin = Math.floor(stats.bestTime / 60).toString().padStart(2, '0');
            const bestSec = (stats.bestTime % 60).toString().padStart(2, '0');
            document.getElementById('endBest').textContent = `${bestMin}:${bestSec}`;
            if (isNewBest) {
                document.getElementById('endBest').style.color = '#ffff00';
                document.getElementById('endBest').textContent += ' ‚òÖ';
            }
            
            let feedback = '';
            if (percentage >= 90) feedback = 'Outstanding! Professional-grade dispatch work.';
            else if (percentage >= 75) feedback = 'Good job. Minor improvements needed.';
            else if (percentage >= 60) feedback = 'Acceptable. Review protocols and response times.';
            else feedback = 'Needs improvement. Focus on key details and unit coordination.';
            document.getElementById('endFeedback').textContent = feedback;
            
            // Cleanup
            callInProgress = false;
            clearInterval(callTimerInterval);
            document.getElementById('responseSection').style.display = 'none';
            document.getElementById('audioViz').classList.add('silent');
            document.getElementById('lineStatus').textContent = 'LINE: STANDBY';
            document.getElementById('endBtn').disabled = true;
            
            saveGameData();
            document.getElementById('endCallModal').classList.add('show');
        }

        function nextCall() {
            document.getElementById('endCallModal').classList.remove('show');
            document.getElementById('callTimer').textContent = '00:00';
            document.getElementById('chatContainer').innerHTML = `
                <div class="system-msg" style="padding: 30px; font-size: 16px; color: var(--red); animation: pulse 2s infinite;">
                    üìû INCOMING EMERGENCY CALL<br>
                    <span style="font-size: 12px; color: #666;">Standby for dispatch...</span>
                </div>
            `;
            document.getElementById('answerBtn').disabled = false;
            document.getElementById('answerBtn').classList.add('answer-btn');
        }

        // End Shift
        function endShift() {
            isPaused = false;
            callInProgress = false;
            clearInterval(callTimerInterval);
            
            // Calculate shift stats
            const shiftDuration = Math.floor((Date.now() - stats.shiftStartTime) / 1000);
            const avgTime = stats.callTimes.length > 0 ? 
                Math.round(stats.callTimes.reduce((a, b) => a + b, 0) / stats.callTimes.length) : 0;
            
            document.getElementById('shiftTotalCalls').textContent = stats.shiftCalls;
            
            const avgMin = Math.floor(avgTime / 60).toString().padStart(2, '0');
            const avgSec = (avgTime % 60).toString().padStart(2, '0');
            document.getElementById('shiftAvgTime').textContent = `${avgMin}:${avgSec}`;
            
            if (stats.bestTime) {
                const bestMin = Math.floor(stats.bestTime / 60).toString().padStart(2, '0');
                const bestSec = (stats.bestTime % 60).toString().padStart(2, '0');
                document.getElementById('shiftBestTime').textContent = `${bestMin}:${bestSec}`;
            }
            
            // Generate analysis
            let analysis = '';
            if (stats.shiftCalls === 0) {
                analysis = 'No calls were completed during this shift. Consider staying on duty longer to gain experience.';
            } else {
                const avgScore = stats.totalScore / stats.totalCalls;
                if (avgScore >= 85) {
                    analysis = `Excellent performance! Your average score of ${Math.round(avgScore)}% demonstrates professional-level competency. Your response times are${avgTime < 180 ? ' exceptional' : ' good'}. Continue maintaining this standard.`;
                } else if (avgScore >= 70) {
                    analysis = `Good work. Your average score of ${Math.round(avgScore)}% shows solid fundamentals. Focus on improving response relevance and unit coordination. Consider reviewing emergency protocols for ${stats.callTimes.length > 0 && avgTime > 300 ? 'faster response times' : 'better accuracy'}.`;
                } else {
                    analysis = `Your performance needs improvement. With an average score of ${Math.round(avgScore)}%, focus on: 1) Taking better notes, 2) Dispatching correct units faster, 3) Using radio communications effectively. Review training materials before next shift.`;
                }
            }
            document.getElementById('shiftAnalysis').textContent = analysis;
            
            document.getElementById('pauseModal').classList.remove('show');
            document.getElementById('endShiftModal').classList.add('show');
            
            // Reset shift
            stats.shiftCalls = 0;
            stats.shiftStartTime = Date.now();
            stats.callTimes = [];
            saveGameData();
        }

        function closeShiftModal() {
            document.getElementById('endShiftModal').classList.remove('show');
            location.reload();
        }

        function startNewShift() {
            document.getElementById('endShiftModal').classList.remove('show');
            document.getElementById('chatContainer').innerHTML = `
                <div class="system-msg" style="padding: 30px; font-size: 16px; color: var(--red); animation: pulse 2s infinite;">
                    üìû INCOMING EMERGENCY CALL<br>
                    <span style="font-size: 12px; color: #666;">Standby for dispatch...</span>
                </div>
            `;
            document.getElementById('answerBtn').disabled = false;
            document.getElementById('answerBtn').classList.add('answer-btn');
            document.getElementById('lineStatus').textContent = 'LINE: STANDBY';
            document.getElementById('lineStatus').classList.add('emergency-mode');
        }

        function clearNotepad() {
            document.getElementById('notepad').value = '';
        }

        // Scenario Generator (simplified)
        function generateScenario() {
            const firstNames = ['JAMES', 'MARY', 'JOHN', 'PATRICIA', 'ROBERT', 'JENNIFER'];
            const lastNames = ['SMITH', 'JOHNSON', 'WILLIAMS', 'BROWN', 'JONES', 'GARCIA'];
            const streets = ['OAK', 'MAPLE', 'PINE', 'CEDAR', 'ELM', 'MAIN'];
            const types = ['STREET', 'AVENUE', 'DRIVE', 'LANE'];
            const locations = ['RESIDENCE', 'APARTMENT', 'OFFICE', 'STORE', 'RESTAURANT'];
            
            const emergencyTypes = {
                MEDICAL: ['CARDIAC ARREST', 'DIFFICULTY BREATHING', 'SEVERE BLEEDING', 'OVERDOSE'],
                FIRE: ['STRUCTURE FIRE', 'KITCHEN FIRE', 'GAS LEAK', 'SMOKE'],
                POLICE: ['BURGLARY', 'DOMESTIC DISTURBANCE', 'ASSAULT', 'SUSPICIOUS PERSON'],
                SWAT: ['ACTIVE SHOOTER', 'HOSTAGE', 'ARMED ROBBERY']
            };
            
            const categoryKeys = Object.keys(emergencyTypes);
            const category = categoryKeys[Math.floor(Math.random() * categoryKeys.length)];
            
            return {
                id: Date.now(),
                callerName: `${firstNames[Math.floor(Math.random() * firstNames.length)]} ${lastNames[Math.floor(Math.random() * lastNames.length)].charAt(0)}.`,
                location: `${Math.floor(Math.random() * 9000) + 100} ${streets[Math.floor(Math.random() * streets.length)]} ${types[Math.floor(Math.random() * types.length)]}, ${locations[Math.floor(Math.random() * locations.length)]}`,
                phone: `(${Math.floor(Math.random() * 900) + 100}) ${Math.floor(Math.random() * 900) + 100}-${Math.floor(Math.random() * 9000) + 1000}`,
                type: emergencyTypes[category][Math.floor(Math.random() * emergencyTypes[category].length)],
                category: category,
                weapon: Math.random() > 0.7 ? ['knife', 'handgun', 'rifle'][Math.floor(Math.random() * 3)] : null,
                description: ['tall male, black jacket', 'short female, blonde hair', 'heavyset male, beard'][Math.floor(Math.random() * 3)],
                requiredUnits: category === 'MEDICAL' ? ['ems'] : category === 'FIRE' ? ['fire', 'ems'] : category === 'POLICE' ? ['police'] : ['police', 'swat', 'ems']
            };
        }

        function getOpeningLine(scenario) {
            const openings = [
                'Help! I need help right now!',
                'Oh my god, please send someone quickly!',
                'There\'s an emergency! I don\'t know what to do!',
                'Please help me, I\'m scared!',
                'Something terrible is happening!'
            ];
            return openings[Math.floor(Math.random() * openings.length)];
        }

        // Initialize
        window.onload = function() {
            loadGameData();
        };

        // Close volume panel when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.volume-container')) {
                document.getElementById('volumePanel').classList.remove('show');
            }
        });
    </script>
</body>
    <!-- ADD THIS AT THE BOTTOM before </body> -->
    <script>
        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(() => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker failed', err));
        }
    </script>
</body>
</html>
</html>